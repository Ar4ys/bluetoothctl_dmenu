#!/bin/bash
dmenu_list_mode="-l 10"
backend="bluetoothctl"
connected_device=""
unpaired_devices=""

#check whether bluetoothctl is installed and is working correctly
is_bluetoothctl_installed_correctly() {
	if [[ $($backend -v) == bluetoothctl* &&
	$($backend power on) == "Changing power on succeeded" &&
	$($backend list) == Controller* ]]; then
		echo $backend 'is installed and configured correctly'
	fi
}

get_already_paired_devices() {
	IFS=
	echo $($backend paired-devices);
}

print_connected_devices() {
	while read -r _ mac name; do
		if [[ $($backend info $mac | grep "Connected: yes") ]]; then
			printf '%-40s%s\n' "$name" "$mac"
		fi
	done < <(get_already_paired_devices)
}

get_unpaired_devices() {
	unpaired_devices=""
	while read -r _ mac name; do
	 	if [[ $($backend info $mac | grep "Paired: no") ]]; then
	 		unpaired_devices+="$name | $mac\n"
	 	fi
	done < <($backend devices) 
}

# $1-text; $2-var name
dmenu_notify() {
	: | dmenu -p "$1"
}

print_paired_devices() {
	while read -r _ mac name; do
		printf '%-40s%s\n' "$name" "$mac"
	done < <(get_already_paired_devices)
}

connect_device() {
	$backend connect $2 && (
	echo $2 '(connected)';
	$connected_device="hello"
	);
	echo $connected_device;
}

# $1-command; $2-mac; $3-name
btctl_command() {
	local status
	status="$($backend $1 $2)"
	printf "$status\n"
	if [[ $(echo "$status" | grep -i "successful\|succeeded\|removed") ]]; then
		dmenu_notify "$3: Successful operation '$1' (press enter)"
	elif [[ $(echo "$status" | grep -i "failed") ]]; then
		dmenu_notify "$3: Failed operation '$1' (press enter)"
	fi
}

disconnect_all_devices() {
	$($backend disconnect);
}

create_options() {
	local device_info

	if [[ $($backend info $mac | grep "$1") ]]; then
		submenu_options+="$2 "
	else
		submenu_options+="$3 "
	fi
}

open_device_submenu() {
	local submenu_options
	local name
	local mac
	local option
	submenu_options=""
	name=$(echo "$1" | cut -d "|" -f 1)
	mac=$(echo "$1" | cut -d "|" -f 2)
	previous_menu=$2
	current_menu="$2_submenu"

	create_options "Connected: yes" "disconnect" "connect" 
	create_options "Trusted: yes" "untrust" "trust"
	create_options "Blocked: yes" "unblock" "block"
	create_options "Paired: yes" "remove" "pair"

	read -r connect trust block pair < <(echo "$submenu_options")
	option=$(printf "%s\n" $connect $trust $block $pair | dmenu -p "$name")
	[[ $option ]] || exit 1

	btctl_command $option $mac "$name"
}

open_connected_devices_menu() {
	previous_menu="main"
	current_menu="main_connected"
	echo "Previous menu: $previous_menu, current menu: $current_menu"
	device=$(print_connected_devices | dmenu -p "Connected devices" $dmenu_list_mode)
	[[ $device ]] || exit 1
	open_device_submenu "$device" "$current_menu"
}

open_paired_devices_menu() {
	previous_menu="main"
	current_menu="main_paired"
	echo "Previous menu: $previous_menu, current menu: $current_menu"
	device=$(print_paired_devices | dmenu -p "Paired devices" $dmenu_list_mode)
	[[ $device ]] || exit 1
	open_device_submenu "$device" "$current_menu"
}

open_scan_devices_menu() {
	previous_menu="main"
	current_menu="main_scan"

	echo "Previous menu: $previous_menu, current menu: $current_menu"
	$backend scan on > /dev/null &

	while [[ "1" == "1" ]]; do
		get_unpaired_devices
		device=$(printf "update\n$unpaired_devices" | dmenu -p "scan" $dmenu_list_mode)

		if [[ -z $device ]]; then
			pkill -P $$
			break
		elif [[ $device == "update" ]]; then
			continue
		else 
			open_device_submenu "$device" "$current_menu"
			pkill -P $$
			break
		fi 
	done
}

get_main_menu() {
	echo -e "Show connected devices\nShow paired devices\nScan for devices"
}

function finish {
	# TODO: when we were in the devices submenu and trying to return to the main menu, it stops working
	# TODO: if we go to paired devices, then to main menu, then to paired devices, it will exit the app as you hit ESC to go back
	if [[ "$previous_menu" == "main" ]]; then
		open_main_menu
	elif [[ "$previous_menu" == "main_connected" ]]; then
		open_connected_devices_menu
	elif [[ "$previous_menu" == "main_paired" ]]; then
		open_paired_devices_menu
	elif [[ "$previous_menu" == "main_scan" ]]; then
		open_scan_devices_menu
	fi
}

trap finish EXIT

open_main_menu() {
	local submenu
	local device

	previous_menu="main"
	current_menu="main"

	echo "Previous menu: $previous_menu, current menu: $current_menu"

	submenu=$(get_main_menu | dmenu)
	[[ $submenu ]] || exit 1

	if [[ $submenu == "Show connected devices" ]]; then
		open_connected_devices_menu
	elif [[ $submenu == "Show paired devices" ]]; then
		open_paired_devices_menu
	elif [[ $submenu == "Scan for devices" ]]; then
		open_scan_devices_menu
	fi
}

is_bluetoothctl_installed_correctly
open_main_menu

